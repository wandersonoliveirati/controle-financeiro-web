{% extends "base.html" %}
{% block content %}

<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">üìä Dashboard Financeiro</h3>
  </div>

  <!-- KPIs do m√™s atual -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-muted">Total do m√™s</div>
          <div class="fs-3 fw-bold" id="kpi-mes-geral" data-valor="{{ total_geral|default(0) }}">R$ 0,00</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-4">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-success">Pago</div>
          <div class="fs-4 fw-bold" id="kpi-mes-pago" data-valor="{{ total_mes_pago|default(0) }}">R$ 0,00</div>
          <div class="small text-muted">Registros: <span id="kpi-mes-pago-qtd">{{ qtd_mes_pago|default(0) }}</span></div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-4">
      <div class="card h-100">
        <div class="card-body text-center">
          <div style="color:#b36b00;">Em aberto</div>
          <div class="fs-4 fw-bold" id="kpi-mes-aberto" data-valor="{{ total_mes_aberto|default(0) }}">R$ 0,00</div>
          <div class="small text-muted">Registros: <span id="kpi-mes-aberto-qtd">{{ qtd_mes_aberto|default(0) }}</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Total anual -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class="fw-semibold">üóìÔ∏è Total Anual</div>
          <div class="fs-4 fw-bold" id="kpi-anual" data-valor="{{ total_anual|default(0) }}">R$ 0,00</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr√°ficos lado a lado -->
  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="fw-semibold mb-2">Gastos por M√™s</div>
          <canvas id="chartMeses" height="240"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="fw-semibold mb-2">Gastos por Categoria</div>
          <canvas id="chartCategorias" height="240"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Dados para os gr√°ficos como JSON puro (evita erros do linter) -->
<script id="totaisMesData" type="application/json">
  {{ totais_mes|tojson }}
</script>
<script id="totaisCategoriasData" type="application/json">
  {{ totais_categoria|tojson }}
</script>

<script>
// === KPIs ===
(function() {
  const fmt = n => new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(n || 0);
  ["kpi-mes-geral","kpi-mes-pago","kpi-mes-aberto","kpi-anual"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = fmt(Number(el.getAttribute("data-valor") || "0"));
  });
})();

// === Dados para gr√°ficos (lidos dos <script type="application/json">) ===
const totaisMes = JSON.parse(document.getElementById("totaisMesData").textContent || "{}");
const totaisCategorias = JSON.parse(document.getElementById("totaisCategoriasData").textContent || "{}");

// === Gr√°fico por M√™s ===
(function(){
  const ctx = document.getElementById("chartMeses");
  if (!ctx) return;
  const labels = Object.keys(totaisMes);
  const data = labels.map(k => totaisMes[k]);

  new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: "R$ por m√™s", data }] },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: {
          label: c => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c.parsed.y||0)
        }}
      },
      scales: {
        y: { ticks: {
          callback: v => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v)
        }}
      }
    }
  });
})();

// === Gr√°fico por Categoria ===
(function(){
  const ctx = document.getElementById("chartCategorias");
  if (!ctx) return;
  const labels = Object.keys(totaisCategorias);
  const data = labels.map(k => totaisCategorias[k]);

  new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: "R$ por categoria", data }] },
    options: {
      indexAxis: "y",
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: {
          label: c => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(c.parsed.x||0)
        }}
      },
      scales: {
        x: { ticks: {
          callback: v => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v)
        }}
      }
    }
  });
})();
</script>

{% endblock %}
