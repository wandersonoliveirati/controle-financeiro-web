{% extends "base.html" %}
{% block content %}

<div class="container py-3">

  <!-- T√≠tulo -->
  <div class="d-flex align-items-center mb-2">
    <h3 class="mb-0">üßæ Gastos</h3>
  </div>

  <!-- Filtros -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-6">
          <label class="form-label">Buscar descri√ß√£o ou categoria</label>
          <input id="busca" type="text" class="form-control" placeholder="Ex.: aluguel, mercado, lazer...">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Categoria</label>
          <select id="filtro-categoria" class="form-select">
            <option value="">Todas as categorias</option>
            <!-- op√ß√µes preenchidas no onload, a partir da lista -->
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Per√≠odo base</label>
          <input id="filtro-mes" type="month" class="form-control">
        </div>
      </div>

      <!-- Abas de per√≠odo (mesma UI para todas) -->
      <div class="btn-group mt-3" role="group" aria-label="Modo de exibi√ß√£o">
        <button type="button" class="btn btn-outline-secondary active" id="btn-itens">Itens</button>
        <button type="button" class="btn btn-outline-secondary" id="btn-mensal">Mensal</button>
        <button type="button" class="btn btn-outline-secondary" id="btn-anual">Anual</button>
      </div>
    </div>
  </div>

  <!-- Resumo -->
  <div class="alert alert-info d-flex justify-content-between align-items-center" id="resumo">
    <div><strong>Total exibido:</strong> <span id="total-exibido">R$ 0,00</span></div>
    <div><strong>Registros:</strong> <span id="qtd-exibida">0</span></div>
  </div>

  <!-- Lista em cards -->
  <div id="cards-itens" class="d-flex flex-column gap-2">
    {% for g in gastos %}
    <div class="card item-card"
         data-iso="{{ g.data_iso or g.data }}"
         data-categoria="{{ g.categoria }}"
         data-descricao="{{ g.descricao }}"
         data-valor="{{ g.valor }}"
         data-id="{{ g.id }}">
      <div class="card-body py-2">

        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div class="d-flex flex-column">
            <div class="small text-muted">{{ g.data }}</div>
            <div class="fw-semibold">{{ g.descricao }}</div>
            <span class="badge rounded-pill bg-secondary mt-1">{{ g.categoria }}</span>
          </div>

          <div class="text-end">
            <div class="fs-6 fw-bold money" data-valor="{{ g.valor }}">R$ 0,00</div>
            <div class="mt-2 d-flex justify-content-end gap-2">
              <a class="btn btn-sm btn-outline-primary"
                 href="{{ url_for('editar', gid=g.id) }}">Editar</a>
              <a class="btn btn-sm btn-outline-danger"
                 href="{{ url_for('excluir', gid=g.id) }}"
                 onclick="return confirm('Excluir este gasto?');">Excluir</a>
            </div>
          </div>
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Bot√£o flutuante adicionar -->
  <a href="{{ url_for('adicionar') }}"
     class="btn btn-primary rounded-circle position-fixed"
     style="right: 16px; bottom: 16px; width: 48px; height: 48px; display:flex; align-items:center; justify-content:center;">
    <span class="fs-4">+</span>
  </a>

</div>

<!-- Script de filtro/totaliza√ß√£o -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const busca = document.getElementById("busca");
  const selCat = document.getElementById("filtro-categoria");
  const mesRef = document.getElementById("filtro-mes");

  const btnItens  = document.getElementById("btn-itens");
  const btnMensal = document.getElementById("btn-mensal");
  const btnAnual  = document.getElementById("btn-anual");

  const totalExibido = document.getElementById("total-exibido");
  const qtdExibida   = document.getElementById("qtd-exibida");
  const cards        = Array.from(document.querySelectorAll("#cards-itens .item-card"));
  const moneySpans   = Array.from(document.querySelectorAll("#cards-itens .money"));

  // formata valores vis√≠veis
  const fmtBRL = (n) => new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(n);

  // inicializa valores formatados em cada card
  moneySpans.forEach(span => {
    const v = Number(span.getAttribute("data-valor") || "0");
    span.textContent = fmtBRL(v);
  });

  // popula categorias √∫nicas
  (function fillCategorias(){
    const set = new Set();
    cards.forEach(c => {
      const cat = (c.getAttribute("data-categoria") || "").trim();
      if (cat) set.add(cat);
    });
    Array.from(set).sort().forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      selCat.appendChild(opt);
    });
  })();

  // modo de exibi√ß√£o
  let modo = "itens"; // 'itens' | 'mensal' | 'anual'
  function setModo(novo) {
    modo = novo;
    [btnItens, btnMensal, btnAnual].forEach(b => b.classList.remove("active"));
    if (novo === "itens")  btnItens.classList.add("active");
    if (novo === "mensal") btnMensal.classList.add("active");
    if (novo === "anual")  btnAnual.classList.add("active");
    aplicarFiltros();
  }

  btnItens.addEventListener("click",  () => setModo("itens"));
  btnMensal.addEventListener("click", () => setModo("mensal"));
  btnAnual.addEventListener("click",  () => setModo("anual"));

  // auxiliar de data
  function ymd(dateIso) {
    // espera 'YYYY-MM-DD' (j√° vem assim do backend)
    return (dateIso || "").slice(0, 10);
  }
  function ym(dateIso) { return ymd(dateIso).slice(0,7); }
  function y(dateIso)  { return ymd(dateIso).slice(0,4); }

  // m√™s/ano de refer√™ncia
  function mesReferencia() {
    // retorna 'YYYY-MM' (input month) ou m√™s atual
    const val = (mesRef.value || "").trim();
    if (val) return val;
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${d.getFullYear()}-${m}`;
  }
  function anoReferencia() {
    const val = (mesRef.value || "").trim();
    if (val) return val.slice(0,4);
    return String(new Date().getFullYear());
  }

  // aplica os filtros na lista + atualiza total/contagem
  function aplicarFiltros() {
    const q = (busca.value || "").toLowerCase().trim();
    const cat = (selCat.value || "").toLowerCase();

    const refYM = mesReferencia();  // YYYY-MM
    const refY  = anoReferencia();  // YYYY

    let total = 0;
    let count = 0;

    cards.forEach(card => {
      const desc = (card.getAttribute("data-descricao") || "").toLowerCase();
      const categoria = (card.getAttribute("data-categoria") || "").toLowerCase();
      const iso = card.getAttribute("data-iso") || "";
      const val = Number(card.getAttribute("data-valor") || "0");

      // filtro texto/categoria
      let ok = true;
      if (q && !(desc.includes(q) || categoria.includes(q))) ok = false;
      if (ok && cat && cat !== categoria) ok = false;

      // filtro de per√≠odo conforme modo
      if (ok) {
        if (modo === "mensal") {
          ok = ym(iso) === refYM;
        } else if (modo === "anual") {
          ok = y(iso) === refY;
        } else { // itens
          // se usu√°rio escolheu m√™s no input, filtra por esse m√™s;
          // se n√£o, mostra todos
          if (mesRef.value) ok = ym(iso) === refYM;
        }
      }

      if (ok) {
        card.style.display = "";
        total += val;
        count += 1;
      } else {
        card.style.display = "none";
      }
    });

    totalExibido.textContent = fmtBRL(total);
    qtdExibida.textContent = String(count);
  }

  // eventos de filtro
  busca.addEventListener("input", aplicarFiltros);
  selCat.addEventListener("change", aplicarFiltros);
  mesRef.addEventListener("change", aplicarFiltros);

  // primeira aplica√ß√£o
  aplicarFiltros();
});
</script>

{% endblock %}
