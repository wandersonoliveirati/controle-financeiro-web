{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="mb-3">✏️ Editar Gasto</h2>

  <div class="card">
    <div class="card-body">
      <form method="post" action="{{ url_for('editar', gid=indice) }}">
        <div class="row g-3">

          <div class="col-12 col-md-4">
            <label class="form-label">Data</label>
            <input type="date" name="data" class="form-control"
                   value="{{ gasto.data_iso or gasto.data }}" required>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Categoria</label>
            {% set atual = gasto.categoria %}
            <select id="categoria-editar" name="categoria" class="form-select" required>
              {% if categorias %}
                {% for cat in categorias %}
                  {% if cat %}
                    <option value="{{ cat }}" {% if cat == atual %}selected{% endif %}>{{ cat }}</option>
                  {% endif %}
                {% endfor %}
              {% else %}
                <option value="{{ atual }}" selected>{{ atual }}</option>
              {% endif %}
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Valor</label>
            <input type="text" name="valor" class="form-control money-field"
                   value="{{ gasto.valor }}" inputmode="decimal" autocomplete="off" required>
          </div>

          <div class="col-12">
            <label class="form-label">Descrição</label>
            <input type="text" name="descricao" class="form-control"
                   value="{{ gasto.descricao }}">
          </div>

        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary">Salvar</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('listar_gastos') }}">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const valorInput = document.querySelector(".money-field");

  function normalizeInitial(s) {
    if (!s) return "";
    s = String(s).replace(/[^\d,.\-]/g, "");
    if (s.includes(".") && !s.includes(",")) s = s.replace(".", ",");
    const parts = s.split(",");
    if (parts.length > 2) s = parts[0] + "," + parts.slice(1).join("").replace(/,/g, "");
    return s;
  }
  valorInput.value = normalizeInitial(valorInput.value);

  function sanitizeTyping(s) {
    s = String(s).replace(/[^\d,]/g, "");
    const i = s.indexOf(",");
    if (i !== -1) s = s.slice(0, i + 1) + s.slice(i + 1).replace(/,/g, "");
    return s;
  }
  valorInput.addEventListener("input", function () {
    const pos = this.selectionStart;
    const before = this.value;
    this.value = sanitizeTyping(this.value);
    const delta = this.value.length - before.length;
    this.setSelectionRange(Math.max(0, pos + delta), Math.max(0, pos + delta));
  });

  const form = document.querySelector("form");
  form.addEventListener("submit", function () {
    let s = valorInput.value.trim();
    s = s.replace(/[^\d,.\-]/g, "").replace(/\./g, "").replace(",", ".");
    valorInput.value = s;
  });
});
</script>
{% endblock %}
