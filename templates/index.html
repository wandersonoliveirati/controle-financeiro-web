{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="mb-3">➕ Adicionar Gasto</h2>

  <div class="card">
    <div class="card-body">
      <form method="post" action="{{ url_for('adicionar') }}">
        <div class="row g-3">

          <div class="col-12 col-md-4">
            <label class="form-label">Data</label>
            <input type="date" name="data" class="form-control" required>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Categoria</label>
            <select id="categoria" name="categoria" class="form-select" required>
              <option value="">Selecione...</option>
              {% if categorias %}
                {% for cat in categorias %}
                  {% if cat %}<option value="{{ cat }}">{{ cat }}</option>{% endif %}
                {% endfor %}
              {% else %}
                <option value="Fixo">Fixo</option>
                <option value="Lazer">Lazer</option>
                <option value="Itens Casa">Itens Casa</option>
              {% endif %}
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Valor</label>
            <input
              type="text"
              name="valor"
              class="form-control money-field"
              placeholder="Ex.: 504,97"
              inputmode="decimal"
              autocomplete="off"
              required>
          </div>

          <div class="col-12">
            <label class="form-label">Descrição</label>
            <input type="text" name="descricao" class="form-control" placeholder="Opcional">
          </div>

          <!-- Checkbox só quando categoria = Fixo -->
          <div class="col-12" id="container-fixo" style="display:none;">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" value="1" id="replicar_fim_ano" name="replicar_fim_ano">
              <label class="form-check-label" for="replicar_fim_ano">
                Gasto fixo: <span class="text-muted">replicar mensalmente até dezembro do ano da data informada</span>
              </label>
            </div>
          </div>

        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary">Salvar</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('listar_gastos') }}">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectCat = document.getElementById("categoria");
  const boxFixo   = document.getElementById("container-fixo");
  function toggleFixo() {
    const v = (selectCat.value || "").trim().toLowerCase();
    boxFixo.style.display = (v === "fixo") ? "block" : "none";
    if (v !== "fixo") {
      const cb = document.getElementById("replicar_fim_ano");
      if (cb) cb.checked = false;
    }
  }
  selectCat.addEventListener("change", toggleFixo);
  toggleFixo();

  // Campo Valor: digitação livre com vírgula; sem formatação automática
  const valorInput = document.querySelector(".money-field");

  function normalizeInitial(s) {
    if (!s) return "";
    s = String(s).replace(/[^\d,.\-]/g, "");
    if (s.includes(".") && !s.includes(",")) s = s.replace(".", ",");
    const parts = s.split(",");
    if (parts.length > 2) s = parts[0] + "," + parts.slice(1).join("").replace(/,/g, "");
    return s;
  }
  valorInput.value = normalizeInitial(valorInput.value);

  function sanitizeTyping(s) {
    s = String(s).replace(/[^\d,]/g, "");
    const i = s.indexOf(",");
    if (i !== -1) s = s.slice(0, i + 1) + s.slice(i + 1).replace(/,/g, "");
    return s;
  }
  valorInput.addEventListener("input", function () {
    const pos = this.selectionStart;
    const before = this.value;
    this.value = sanitizeTyping(this.value);
    const delta = this.value.length - before.length;
    this.setSelectionRange(Math.max(0, pos + delta), Math.max(0, pos + delta));
  });

  // no submit: 504,97 -> 504.97
  const form = document.querySelector("form");
  form.addEventListener("submit", function () {
    let s = valorInput.value.trim();
    s = s.replace(/[^\d,.\-]/g, "").replace(/\./g, "").replace(",", ".");
    valorInput.value = s;
  });
});
</script>
{% endblock %}
